## 程序执行顺序

一个程序的运行是通过CPU调度执行的。CPU在执行程序时，具有顺序的概念。这个顺序可以分为串行执行、并行执行和并发执行。

### 串行执行

所谓的串行执行，指的是按照`先后顺序`执行。当执行某一个任务时，后面的任务只有等待前面的任务执行结束才能被执行。
![Snipaste_2022-03-12_13-54-42](https://gitee.com/bruce_qiq/picture/raw/master/2022-3-12/1647064496083-Snipaste_2022-03-12_13-54-42.png)
1. 上述任务，执行的顺序是A->B->C。

2. 任务是串行化执行，前面的任务执行时，后面的任务处于阻塞状态。

3. 整个过程是串行执行，并发能力降低。

4. 由于是串行执行，只有前面的执行结束后，后面的任务才能执行。降低了CPU调度的消耗，同时也能提高应用程序的一致性。

### 并行执行

所谓的并行执行，指的是同一时刻，多个任务可以同时执行。这利用了`多核CPU`，能够同时处理多个任务的特点。
![Snipaste_2022-03-12_13-59-29](https://gitee.com/bruce_qiq/picture/raw/master/2022-3-12/1647064779878-Snipaste_2022-03-12_13-59-29.png)
1. 上述任务，A、B和C都可以同时进行。

2. 提高了程序的并发能力。当多个应用程序访问同一个资源时，容易导致数据的不一致。

### 并发执行

所谓的并发执行，从微观的角度讲，是通过CPU在不同的时刻进行任务调度，来执行任务。也就是说，同一时刻只有一个任务在执行，只是不断的切换CPU来达到并行执行的效果。
当时钟滴答触发时，表示当前的任务执行结束，此时会保存任务的上下文。切着切换CPU执行另外一个任务，当时钟滴答再次触发时，正在执行的任务结束，保留当前上下文。接着切换到另外一个任务。
![Snipaste_2022-03-12_14-03-49](https://gitee.com/bruce_qiq/picture/raw/master/2022-3-12/1647065038626-Snipaste_2022-03-12_14-03-49.png)
1. 上诉任务，同一时刻只有一个任务在执行。通过切换CPU不断的切换执行任务。

2. 因为某一个任务执行被中止，需要保留上下文同时还有CPU的不断切换，这加大的系统资源的消耗。

3. 当某一个执行任务被终止，此时当前的任务就会触发中断，也被称之为系统中断。

## 进程、线程与协程

### 进程

进程可以理解为一个应用程序启动时的状态。当程序启动时，会默认创建一个进程。从系统层面讲，进程是系统资源的分配与调度单位，是系统最小的资源分配单位。比如创建多少个线程、占用多少内存等等。

### 程序运行状态

![Snipaste_2022-03-12_14-11-21](https://gitee.com/bruce_qiq/picture/raw/master/2022-3-12/1647065502223-Snipaste_2022-03-12_14-11-21.png)
1. 当启动一个应用程序时，会默认经过上述的几个过程，程序初始化、初始化就绪、等待CPU(执行)、任务挂起和程序终止。

### 进程运行

下图为进程启动时的一个大致过程。init进程->fork主进程->主进程fork子进程。在操作系统运行过程中，可以产生很多的进程。在unix/linux中，正常情况下，子进程是由父进程创建的(fork)，在有子进程创建其它进程。并且父进程是不知道子进程何时结束，当一个进程完成工作后，其父进程需要进行`系统调用`取得子进程的终止状态。
![Snipaste_2022-03-12_14-14-58](https://gitee.com/bruce_qiq/picture/raw/master/2022-3-12/1647065726070-Snipaste_2022-03-12_14-14-58.png)
1. 进程的创建占用系统资源大，就需要开启的进程较少。

2. 在unix/linux下，还会产生`孤儿进程`和`僵尸进程`。

#### 孤儿进程

  孤儿进程是父进程比子进程先结束，则子进程此时没有父进程，于是子进程的父进程就变成了init进程。称为init进程领养孤儿进程。

#### 僵尸进程

僵尸进程是指进程终止，父进程尚未回收子进程，子进程残留资源(PCB)存放在内核中，于是变成僵尸进程。

### 线程

线程的本质还是进程，它是一个轻量级的进程。是程序的执行单位。
1. 线程拥有独立的PCB，但是内存仍然是共享的，内存空间由进程分配，运行环境由进程分配。

2. 线程是系统最小的执行单位。进程是系统最小的资源分配单位。

#### 线程同步

线程同步是为了让多个线程抢同一时刻占同一个资源，仍然保持数据一致性，而采取的一种数据保护机制。
![Snipaste_2022-03-12_16-27-56](https://gitee.com/bruce_qiq/picture/raw/master/2022-3-12/1647073686589-Snipaste_2022-03-12_16-27-56.png)

### 协程

协程是一种轻量级的线程。由于线程是系统最小的执行单位，因此协程是基于线程实现的，协程的创建、切换、销毁都是在某个线程中来进行的。

#### 协程轻量级

之所以说，协程是一种轻量级的线程，是因为协程相对线程占用的系统资源更少。假设一个线程被分配的栈资源空间为10M，而一个协程被分配的资源空间是小于一个线程的资源空间，协程可能占用的资源空间为10几kb。
> 栈主要用来保存函数参数、局部变量和返回地址等信息。

### Go协程

#### Go协程区别

1. Golang中语言层面就利用了多核CPU来实现并行程序执行。

2. Golang中的协程意味着并发执行，而其它的协程是通过CPU的切换来实现协程的运行。

3. Golang中的协程推荐使用通道(channel)实现通信，而其他的协程是通过让出和回复执行权实现通信。
